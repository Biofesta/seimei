<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç†Šï¨‘å¼å§“ååˆ¤æ–­ï¼ˆéœŠæ•°è£œæ­£å¼ï¼‰</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  :root { --bg:#fbfbfb; --card:#fff; --muted:#666; }
  body {
    font-family:"Yu Gothic","Hiragino Kaku Gothic ProN",Meiryo,monospace;
    background:var(--bg);
    margin:0; padding:24px;
    color:#222; line-height:1.8;
  }
  .wrap { max-width:920px; margin:0 auto; }
  header { display:flex; gap:12px; align-items:center; margin-bottom:18px; }
  h1 { font-size:20px; margin:0; }

  .card {
    background:var(--card);
    padding:18px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(20,20,20,0.04);
  }

  label { display:block; margin:8px 0 4px; font-weight:600; }

  input[type="text"] {
    width:90%;
    padding:10px;
    font-size:16px;
    border:1px solid #ddd;
    border-radius:6px;
  }

  .grid {
    display:grid;
    grid-template-columns:1fr minmax(2em,2em) 1fr;
    align-items:start;
    row-gap:1em;
  }
  .zenkaku-gap { width:2em; min-width:2em; height:1px; }
  @media(max-width:640px){
    .grid { grid-template-columns:1fr; }
    .zenkaku-gap { display:none; }
  }

  .btns { display:flex; gap:10px; margin-top:12px; }
  button {
    background:#1f8ef1; color:#fff; border:0; padding:10px 14px;
    border-radius:8px; cursor:pointer; font-weight:700;
  }
  button:disabled { opacity:0.5; cursor:not-allowed; }

  #result {
    white-space: normal;
    word-break: break-word;
    max-width: 40em;
    background:#fafafa;
    padding:12px;
    border-radius:8px;
    border:1px dashed #eee;
    line-height:1.8;
    font-size:16px;
    margin-top:8px; /* ğŸ”¼ è¨ºæ–­æ ã‚’ä¸Šã«è©°ã‚ã‚‹ */
  }
  p { margin:0; padding:0; }
  .expr {
    display:block;
    color:#8B4513;
    font-size:14px;
    line-height:1.8;
    margin:4px 0 0;
    font-family:monospace;
  }
  .section-title { font-size:20px; font-weight:bold; margin:20px 0 8px; }
  .kaku-title { font-size:18px; font-weight:bold; }
  .compat-subtitle {
    display:block;
    font-size:16px;
    font-weight:bold;
    margin-top:10px;
    margin-bottom:2px;
  }
  .warn { color:red; font-weight:bold; }
  .compat-block { margin-bottom:10px; }

  .print-controls {
    display:flex;
    justify-content:center;
    gap:160px;
    margin-top:40px;
  }
  .print-btn {
    width:160px;
    padding:10px;
    border-radius:8px;
    font-weight:bold;
    cursor:pointer;
    border:none;
  }
  .print-btn.print { background:#4caf50; color:#fff; }
  .print-btn.pdf { background:#2196f3; color:#fff; }

  footer {
    text-align:center;
    margin-top:40px;
  }

  @page { size:A4; margin:8mm; }
  @media print {
    body { zoom:0.80 !important; }
    form, .print-controls, header, #debugSection, #debug { display:none !important; }
    #result { max-width:none; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>å§“ååˆ¤æ–­ by Biofesta</h1></header>

  <section class="card">
    <form id="form" onsubmit="event.preventDefault(); calculate();">
      <div class="grid">
        <div>
          <label for="sei">å§“ï¼ˆè‹—å­—ï¼‰</label>
          <input id="sei" type="text" placeholder="ä¾‹ï¼šæœ¨æ‘" autocomplete="off" />
        </div>
        <div class="zenkaku-gap" aria-hidden="true"></div>
        <div>
          <label for="mei">åï¼ˆåå‰ï¼‰</label>
          <input id="mei" type="text" placeholder="ä¾‹ï¼šå‹æ˜­" autocomplete="off" />
        </div>
      </div>
      <div class="btns">
        <button id="runBtn" type="submit">è¨ºæ–­ã™ã‚‹</button>
        <button type="button" onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
      </div>
    </form>
  </section>

  <!-- ğŸ©µ è¨ºæ–­çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼šã‚¿ã‚¤ãƒˆãƒ«ã‚’éè¡¨ç¤ºã«å¤‰æ›´ -->
  <section style="margin-top:8px" class="card">
    <div id="result">ã¾ã è¨ºæ–­ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>

    <div class="print-controls">
      <button class="print-btn print" id="printBtn">å°åˆ·</button>
      <button class="print-btn pdf" id="pdfBtn">PDFä¿å­˜</button>
    </div>
  </section>

  <section style="margin-top:16px" class="card" id="debugSection">
    <div>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</div>
    <pre id="debug">-</pre>
  </section>
</div>

<script>
let strokes=null, diagnosis=null, compatibility=null, missingInfo=[];

async function loadData(){
  try{
    const [r1,r2,r3]=await Promise.all([
      fetch("strokes_kumazaki_full.json"),
      fetch("diagnosis_data.json"),
      fetch("diagnosis_compatibility.json")
    ]);
    strokes=await r1.json(); diagnosis=await r2.json(); compatibility=await r3.json();
    const totalChars = Object.keys(strokes || {}).length;
    document.getElementById('debug').textContent =
      `ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿OKã€‚ç†Šï¨‘å¼ç™»éŒ²æ–‡å­—æ•°ï¼š${totalChars}å­—`;
  }catch(e){
    document.getElementById('debug').textContent='èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼š'+e.message;
    document.getElementById('runBtn').disabled=true;
  }
}

function splitChars(s){return Array.from(String(s).trim());}

function charVal(ch, prevChar=null){
  if(!strokes)return 0;
  if(ch==="ã€…" && prevChar && prevChar in strokes){
    return strokes[prevChar] || 0;
  }
  if(ch in strokes)return strokes[ch]||0;
  missingInfo.push(ch+"ï¼šæœªç™»éŒ²");
  return 0;
}

function kikkou(n){const good=new Set([1,3,5,6,7,8,11,13,15,16,17,18,21,23,24,25,31,32,33,35,37,38,39,41,45,47,48,52]);if(good.has(n))return'å‰';if(n===0)return'ä¸æ˜';return'å‡¶';}
function toGogyo(n){const m={1:'æœ¨',2:'æœ¨',3:'ç«',4:'ç«',5:'åœŸ',6:'åœŸ',7:'é‡‘',8:'é‡‘',9:'æ°´',0:'æ°´'};return m[n%10];}
function getDiagnosis(t,n){if(!diagnosis||!diagnosis[t])return'è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ãªã—';return diagnosis[t][String(n)]||'è©²å½“ã™ã‚‹è¨ºæ–­æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';}

function wrapZenkaku(t){
  if(!t) return '';
  const red = '<span style="color:red;">ã€è¦æ³¨æ„ã€‘</span>';
  return String(t)
    .replace(/\n+/g, '')                    
    .replace(/ã€è¦æ³¨æ„ã€‘/g, red)
    .replace(/ã€\s*æ³¨\s*ã€‘/g, red)
    .replace(/ï¼ˆ\s*æ³¨\s*ï¼‰/g, red)
    .replace(/(^|[ã€‚ï¼ã€,\s])æ³¨[:ï¼š]/g, `$1${red} `)
    .replace(/(^|[ã€‚ï¼ã€,\s])â€»\s*æ³¨/g, `$1${red} `);
}

const mark = sym => sym === "Ã—" ? `${sym}&emsp;<span class="warn">ã€è¦æ³¨æ„ã€‘</span>` : sym;
function pickCompat(cat,main,other){const key=main+other;const o=compatibility[cat][key]||{symbol:'',text:'',advice:''};return o;}
function calcExpr(chars,rei=false){const p=chars.map((c,i)=>`${c}(${charVal(c,chars[i-1])})`);if(rei)p.push('éœŠæ•°1');return `<div class="expr">ï¼» ${p.join('ï¼‹')} ï¼½</div>`;}

function calculate(){
  missingInfo=[];
  const sei=splitChars(document.getElementById('sei').value||'');
  const mei=splitChars(document.getElementById('mei').value||'');
  if(!sei.length||!mei.length){alert('å§“ã¨åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');return;}

  const s1=sei.map((c,i)=>charVal(c,sei[i-1])).reduce((a,b)=>a+b,0);
  const s2=mei.map((c,i)=>charVal(c,mei[i-1])).reduce((a,b)=>a+b,0);
  const jin=charVal(sei[sei.length-1],sei[sei.length-2])+charVal(mei[0]);
  const ten=s1,chi=s2,gai=(s1+s2)-jin,sou=s1+s2;
  const tenG=toGogyo(ten),jinG=toGogyo(jin),chiG=toGogyo(chi),gaiG=toGogyo(gai),souG=toGogyo(sou);
  const sSucc=pickCompat('success',jinG,tenG);
  const sFoun=pickCompat('foundation',jinG,chiG);
  const sRela=pickCompat('relation',jinG,gaiG);
  const sOver=pickCompat('total',jinG,souG);

  const out=[];
  out.push('<div class="section-title">ã€äº”æ ¼è¨ºæ–­çµæœã€‘</div>');
  out.push(`<div class="kaku-title">ç·æ ¼ï¼š${sou}ï¼ˆ${kikkou(sou)}ï¼‰</div>${calcExpr([...sei,...mei])}${wrapZenkaku(getDiagnosis('sou',sou))}`);
  out.push(`<div class="kaku-title">å¤©æ ¼ï¼š${ten}ï¼ˆï¼ï¼‰</div>${calcExpr(sei)}<p>â€»å¤©æ ¼å˜ç‹¬ã§ã®è¨ºæ–­ã¯ã”ã–ã„ã¾ã›ã‚“ã€‚</p>`);
  out.push(`<div class="kaku-title">ä¸»æ ¼ï¼š${jin}ï¼ˆ${kikkou(jin)}ï¼‰</div>${calcExpr([sei[sei.length-1],mei[0]])}${wrapZenkaku(getDiagnosis('jin',jin))}`);
  out.push(`<div class="kaku-title">åœ°æ ¼ï¼š${chi}ï¼ˆ${kikkou(chi)}ï¼‰</div>${calcExpr(mei)}${wrapZenkaku(getDiagnosis('chi',chi))}`);
  out.push(`<div class="kaku-title">å¤–æ ¼ï¼š${gai}ï¼ˆ${kikkou(gai)}ï¼‰</div>${calcExpr([...sei.slice(0,-1),...mei.slice(1)])}${wrapZenkaku(getDiagnosis('gai',gai))}`);

  out.push('<div class="section-title">ã€ä¸»æ ¼ç›¸æ€§è¨ºæ–­ã€‘</div>');
  const addCompat=(title,sym,txt,adv)=>{
    out.push(`
      <div class="compat-block">
        <span class="compat-subtitle">${title}è¨ºæ–­â‡’${mark(sym)}</span>
        <p>${wrapZenkaku(txt)}</p>
        <p><span style="color:#007bff; font-weight:bold;">ï¼»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼½</span> ${adv.replace(/ã€è¦æ³¨æ„ã€‘/g,'')}</p>
      </div>`);
  };
  addCompat('æˆåŠŸãƒ»ç™ºå±•é‹ï¼ˆä¸»æ ¼â‡”å¤©æ ¼ï¼‰',sSucc.symbol,sSucc.text,sSucc.advice);
  addCompat('åŸºç¤é‹ï¼ˆä¸»æ ¼â‡”åœ°æ ¼ï¼‰',sFoun.symbol,sFoun.text,sFoun.advice);
  addCompat('å¯¾äººãƒ»è·æ¥­é‹ï¼ˆä¸»æ ¼â‡”å¤–æ ¼ï¼‰',sRela.symbol,sRela.text,sRela.advice);
  addCompat('ç·åˆãƒãƒ©ãƒ³ã‚¹ï¼ˆä¸»æ ¼â‡”ç·ç”»ï¼‰',sOver.symbol,sOver.text,sOver.advice);

  document.getElementById('result').innerHTML =
    `<div style="text-align:center;font-weight:700;font-size:18px;margin-bottom:6px;">
       å§“ååˆ¤æ–­ï¼ˆç°¡æ˜“å‹ï¼‰by biofesta
     </div>` + out.join('') +
    `<div style="text-align:center;margin-top:30px;">
       <img src="logo_biofesta.jpg" alt="biofesta logo" style="width:30mm;height:auto;"/>
     </div>`;

  if(missingInfo.length)
    document.getElementById('debug').textContent='ã€æœªç™»éŒ²ã€‘ '+missingInfo.join(' / ');
}

function clearForm(){
  document.getElementById('sei').value='';
  document.getElementById('mei').value='';
  document.getElementById('result').textContent='ã¾ã è¨ºæ–­ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
}

document.getElementById("printBtn").addEventListener("click",()=>{
  const debugSec=document.getElementById("debugSection");
  debugSec.style.display="none";
  window.print();
  debugSec.style.display="";
});

document.getElementById("pdfBtn").addEventListener("click",()=>{
  const debugSec=document.getElementById("debugSection");
  debugSec.style.display="none";
  const main=document.querySelector("#result");
  main.style.transformOrigin="top left";
  main.style.transform="scale(0.82)";
  main.style.width="122%";
  const h=Math.floor(main.offsetHeight);
  main.style.height=h+"px";
  const opt={
    margin:[5,5,5,5],
    filename:'å§“ååˆ¤æ–­çµæœ.pdf',
    image:{type:'jpeg',quality:1},
    html2canvas:{scale:1.0,scrollY:0,windowWidth:1000},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  };
  html2pdf()
    .set(opt)
    .from(main)
    .save()
    .then(()=>{
      main.style.transform="";
      main.style.width="";
      main.style.height="";
      debugSec.style.display="";
    });
});

document.addEventListener('DOMContentLoaded',loadData);
</script>
</body>
</html>
