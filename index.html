<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å§“ååˆ¤æ–­ æ­£çµ±æ´¾ï¼ˆç°¡æ˜“å‹ï¼‰by Biofesta</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  :root { --bg:#fbfbfb; --card:#fff; --muted:#666; }
  body {
    font-family:"Yu Gothic","Hiragino Kaku Gothic ProN",Meiryo,monospace;
    background:var(--bg);
    margin:0; padding:24px;
    color:#222; line-height:1.8;
  }
  .wrap { max-width:920px; margin:0 auto; }
  header { display:flex; gap:12px; align-items:center; margin-bottom:18px; }
  h1 { font-size:20px; margin:0; }

  .card {
    background:var(--card);
    padding:18px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(20,20,20,0.04);
  }

  label { display:block; margin:8px 0 4px; font-weight:600; }
  input[type="text"] {
    width:90%;
    padding:10px;
    font-size:16px;
    border:1px solid #ddd;
    border-radius:6px;
  }

  .grid {
    display:grid;
    grid-template-columns:1fr minmax(2em,2em) 1fr;
    align-items:start;
    row-gap:1em;
  }
  .zenkaku-gap { width:2em; min-width:2em; height:1px; }
  @media(max-width:640px){
    .grid { grid-template-columns:1fr; }
    .zenkaku-gap { display:none; }
  }

  .btns { display:flex; gap:10px; margin-top:12px; }
  button {
    background:#1f8ef1; color:#fff; border:0; padding:10px 14px;
    border-radius:8px; cursor:pointer; font-weight:700;
  }
  button:disabled { opacity:0.5; cursor:not-allowed; }

  #result {
    white-space: normal;
    word-break: break-word;
    max-width: 40em;
    background:#fafafa;
    padding:12px;
    border-radius:8px;
    border:1px dashed #eee;
    line-height:1.8;
    font-size:16px;
  }
  p { margin:0; padding:0; }
  .expr {
    display:block;
    color:#8B4513;
    font-size:14px;
    line-height:1.8;
    margin:4px 0 0;
    font-family:monospace;
  }
  .section-title { font-size:20px; font-weight:bold; margin:20px 0 8px; }
  .kaku-title { font-size:18px; font-weight:bold; }
  .compat-subtitle {
    display:block;
    font-size:16px;
    font-weight:bold;
    margin-top:10px;
    margin-bottom:2px;
  }
  .warn { color:red; font-weight:bold; }
  .compat-block { margin-bottom:10px; }

  /* ğŸˆ¶ å’Œé¢¨ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«äº”æ ¼ãƒ–ãƒ­ãƒƒã‚¯ */
  .gokaku-chart {
    display:flex; flex-wrap:wrap; justify-content:center;
    background:#fdfaf4 url("wasabi_texture.png");
    border:2px solid #d7c19e; border-radius:12px;
    padding:20px; margin-bottom:16px;
    box-shadow:0 3px 10px rgba(0,0,0,0.08);
    position:relative;
  }
  .name-vertical { font-size:20px; font-weight:700; color:#3b2f1c; text-align:center; margin-right:24px; }
  .name-char { margin:4px 0; }
  .gokaku-box { font-family:"Yu Mincho"; color:#4a3b1b; position:relative; }
  .gokaku-box .line { margin:4px 0; font-size:16px; }
  .luck { margin-left:6px; color:#b22222; font-weight:bold; }
  .chart-footer {
    text-align:center; font-size:12px; color:#555; margin-top:8px;
  }
  .chart-footer img {
    width:30mm; height:auto; opacity:0.85; display:block; margin:4px auto;
  }

  .print-controls {
    display:flex;
    justify-content:center;
    gap:160px;
    margin-top:48px;
  }
  .print-btn {
    width:160px;
    padding:10px;
    border-radius:8px;
    font-weight:bold;
    cursor:pointer;
    border:none;
  }
  .print-btn.print { background:#4caf50; color:#fff; }
  .print-btn.pdf { background:#2196f3; color:#fff; }

  @page { size:A4; margin:8mm; }
  @media print {
    body { zoom:0.80 !important; }
    form, .print-controls, header, #debugSection, #debug { display:none !important; }
    #result { max-width:none; }
    .chart-footer img { opacity:0.4; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>å§“ååˆ¤æ–­ æ­£çµ±æ´¾ by Biofesta</h1></header>

  <section class="card">
    <form id="form" onsubmit="event.preventDefault(); calculate();">
      <div class="grid">
        <div>
          <label for="sei">å§“ï¼ˆè‹—å­—ï¼‰</label>
          <input id="sei" type="text" placeholder="ä¾‹ï¼šæœ¨æ‘" autocomplete="off" />
        </div>
        <div class="zenkaku-gap" aria-hidden="true"></div>
        <div>
          <label for="mei">åï¼ˆåå‰ï¼‰</label>
          <input id="mei" type="text" placeholder="ä¾‹ï¼šå‹æ˜­" autocomplete="off" />
        </div>
      </div>
      <div class="btns">
        <button id="runBtn" type="submit">è¨ºæ–­ã™ã‚‹</button>
        <button type="button" onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
      </div>
    </form>
  </section>

  <section style="margin-top:16px" class="card">
    <div id="result">ã¾ã è¨ºæ–­ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
    <div class="print-controls">
      <button class="print-btn print" id="printBtn">å°åˆ·</button>
      <button class="print-btn pdf" id="pdfBtn">PDFä¿å­˜</button>
    </div>
  </section>

  <section style="margin-top:16px" class="card" id="debugSection">
    <div>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</div>
    <pre id="debug">-</pre>
  </section>
</div>

<script>
let strokes=null, diagnosis=null, compatibility=null, missingInfo=[];

/* === ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ === */
async function loadData(){
  try{
    const [r1,r2,r3]=await Promise.all([
      fetch("strokes_kumazaki_full.json"),
      fetch("diagnosis_data.json"),
      fetch("diagnosis_compatibility.json")
    ]);
    strokes=await r1.json(); diagnosis=await r2.json(); compatibility=await r3.json();
    const totalChars = Object.keys(strokes || {}).length;
    document.getElementById('debug').textContent = `ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿OKã€‚ç†Šï¨‘å¼ç™»éŒ²æ–‡å­—æ•°ï¼š${totalChars}å­—`;
  }catch(e){
    document.getElementById('debug').textContent='èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼š'+e.message;
    document.getElementById('runBtn').disabled=true;
  }
}

/* === äº”æ ¼ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æç”» === */
function renderChart(sei, mei, data) {
  const { ten, jin, chi, gai, sou } = data;
  const luck = n => (new Set([1,3,5,6,7,8,11,13,15,16,17,18,21,23,24,25,31,32,33,35,37,38,39,41,45,47,48,52]).has(n) ? "å‰" : "å‡¶");
  const wrap = document.createElement("div");
  wrap.className = "gokaku-chart";
  wrap.innerHTML = `
    <div class="name-vertical">
      ${[...sei,...mei].map(c=>`<div class="name-char">${c}</div>`).join('')}
    </div>
    <div class="gokaku-box">
      <div class="line">å¤©æ ¼ ${ten} <span class="luck">${luck(ten)}</span></div>
      <div class="line">äººæ ¼ ${jin} <span class="luck">${luck(jin)}</span></div>
      <div class="line">åœ°æ ¼ ${chi} <span class="luck">${luck(chi)}</span></div>
      <div class="line">å¤–æ ¼ ${gai} <span class="luck">${luck(gai)}</span></div>
      <div class="line">ç·æ ¼ ${sou} <span class="luck">${luck(sou)}</span></div>
    </div>
    <div class="chart-footer">
      <img src="logo_biofesta.jpg" alt="Biofesta ãƒ­ã‚´">
      <div>å§“ååˆ¤æ–­ æ­£çµ±æ´¾ by Biofesta</div>
    </div>`;
  document.querySelector("#result").prepend(wrap);
}

/* === å„è£œåŠ©é–¢æ•° === */
function splitChars(s){return Array.from(String(s).trim());}
function charVal(ch, prevChar=null){
  if(!strokes)return 0;
  if(ch==="ã€…" && prevChar && prevChar in strokes)return strokes[prevChar]||0;
  if(ch in strokes)return strokes[ch]||0;
  missingInfo.push(ch+"ï¼šæœªç™»éŒ²"); return 0;
}
function kikkou(n){const g=new Set([1,3,5,6,7,8,11,13,15,16,17,18,21,23,24,25,31,32,33,35,37,38,39,41,45,47,48,52]);if(g.has(n))return'å‰';if(n===0)return'ä¸æ˜';return'å‡¶';}
function toGogyo(n){const m={1:'æœ¨',2:'æœ¨',3:'ç«',4:'ç«',5:'åœŸ',6:'åœŸ',7:'é‡‘',8:'é‡‘',9:'æ°´',0:'æ°´'};return m[n%10];}
function getDiagnosis(t,n){if(!diagnosis||!diagnosis[t])return'è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ãªã—';return diagnosis[t][String(n)]||'è©²å½“ã™ã‚‹è¨ºæ–­æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';}
function wrapZenkaku(t){
  if(!t)return '';
  const red='<span style="color:red;">ã€è¦æ³¨æ„ã€‘</span>';
  return String(t).replace(/\n+/g,'').replace(/ã€è¦æ³¨æ„ã€‘/g,red);
}

/* === ãƒ¡ã‚¤ãƒ³è¨ºæ–­ === */
function calculate(){
  missingInfo=[];
  const sei=splitChars(document.getElementById('sei').value||'');
  const mei=splitChars(document.getElementById('mei').value||'');
  if(!sei.length||!mei.length){alert('å§“ã¨åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');return;}

  const s1=sei.map((c,i)=>charVal(c,sei[i-1])).reduce((a,b)=>a+b,0);
  const s2=mei.map((c,i)=>charVal(c,mei[i-1])).reduce((a,b)=>a+b,0);
  const jin=charVal(sei[sei.length-1],sei[sei.length-2])+charVal(mei[0]);
  const ten=s1,chi=s2,gai=(s1+s2)-jin,sou=s1+s2;

  const out=[];
  out.push('<div class="section-title">ã€äº”æ ¼è¨ºæ–­çµæœã€‘</div>');
  out.push(`<div class="kaku-title">ç·æ ¼ï¼š${sou}ï¼ˆ${kikkou(sou)}ï¼‰</div>`);
  out.push(`<div class="kaku-title">ä¸»æ ¼ï¼š${jin}ï¼ˆ${kikkou(jin)}ï¼‰</div>`);
  out.push(`<div class="kaku-title">åœ°æ ¼ï¼š${chi}ï¼ˆ${kikkou(chi)}ï¼‰</div>`);
  out.push(`<div class="kaku-title">å¤–æ ¼ï¼š${gai}ï¼ˆ${kikkou(gai)}ï¼‰</div>`);

  document.getElementById('result').innerHTML=out.join('');
  renderChart(sei, mei, {ten, jin, chi, gai, sou});

  if(missingInfo.length)
    document.getElementById('debug').textContent='ã€æœªç™»éŒ²ã€‘ '+missingInfo.join(' / ');
}

/* === å„ç¨®æ“ä½œ === */
function clearForm(){
  document.getElementById('sei').value='';
  document.getElementById('mei').value='';
  document.getElementById('result').textContent='ã¾ã è¨ºæ–­ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
}
document.getElementById("printBtn").addEventListener("click",()=>{
  const debugSec=document.getElementById("debugSection");
  debugSec.style.display="none"; window.print(); debugSec.style.display="";
});
document.getElementById("pdfBtn").addEventListener("click",()=>{
  const debugSec=document.getElementById("debugSection");
  debugSec.style.display="none";
  const main=document.querySelector("#result");
  main.style.transformOrigin="top left";
  main.style.transform="scale(0.82)";
  main.style.width="122%";
  const opt={
    margin:[5,5,5,5],
    filename:'å§“ååˆ¤æ–­çµæœ.pdf',
    image:{type:'jpeg',quality:1},
    html2canvas:{scale:1.0,scrollY:0,windowWidth:1000},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  };
  html2pdf().set(opt).from(main).save().then(()=>{
    main.style.transform=""; main.style.width=""; debugSec.style.display="";
  });
});
document.addEventListener('DOMContentLoaded',loadData);
</script>
</body>
</html>
