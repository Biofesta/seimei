<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>熊﨑式姓名判断（霊数補正式）</title>
</head>
<body style="font-family:'Yu Gothic','Hiragino Kaku Gothic ProN',Meiryo,monospace;background:#fbfbfb;color:#222;line-height:1.8;margin:0;padding:24px;">
<div style="max-width:920px;margin:0 auto;">
  <h1 style="font-size:18px;margin-bottom:16px;">熊﨑式姓名判断</h1>

  <div style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,20,0.04);">
    <form id="form" onsubmit="event.preventDefault(); calculate();">
      <label>姓（苗字）<br><input id="sei" type="text" style="width:100%;padding:10px;font-size:16px;border:1px solid #ddd;border-radius:6px;"></label><br>
      <label>名（名前）<br><input id="mei" type="text" style="width:100%;padding:10px;font-size:16px;border:1px solid #ddd;border-radius:6px;"></label><br>
      <button type="submit" style="background:#1f8ef1;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700;">診断する</button>
      <button type="button" onclick="clearForm()" style="margin-left:8px;padding:10px 14px;border-radius:8px;">クリア</button>
    </form>
  </div>

  <div style="margin-top:16px;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,20,0.04);">
    <pre id="result" style="white-space:pre-wrap;word-break:break-word;font-size:15px;line-height:1.9;">まだ診断されていません。</pre>
  </div>
</div>

<script>
let strokes=null,diagnosis=null,compatibility=null,missingInfo=[];

async function loadData(){
  try{
    const [r1,r2,r3]=await Promise.all([
      fetch("strokes_kumazaki_full.json"),
      fetch("diagnosis_data.json"),
      fetch("diagnosis_compatibility.json")
    ]);
    strokes=await r1.json(); diagnosis=await r2.json(); compatibility=await r3.json();
  }catch(e){
    document.getElementById('result').textContent='データ読み込みエラー：'+e.message;
  }
}

function splitChars(s){return Array.from(String(s).trim());}
function charVal(ch){if(!strokes)return 0;if(ch in strokes)return strokes[ch];missingInfo.push(ch+"：未登録");return 0;}
function kikkou(n){const good=new Set([1,3,5,6,7,8,11,13,15,16,17,18,21,23,24,25,31,32,33,35,37,39,41,45,47,48,52]);if(good.has(n))return"吉";if(n===0)return"不明";return"凶";}
function toGogyo(n){const m={1:'木',2:'木',3:'火',4:'火',5:'土',6:'土',7:'金',8:'金',9:'水',0:'水'};return m[n%10];}
function getDiagnosis(t,n){if(!diagnosis||!diagnosis[t])return'';return diagnosis[t][String(n)]||'';}

function formatSection(title){return`【${title}】\n`;}
function formatItem(name,num,fortune,text){
  return `${name}：${num}（${fortune}）\n${wrap30(text)}\n`;
}
function wrap30(text){
  let out='',line='',count=0;
  for(const ch of text){
    count += (ch.charCodeAt(0)<=0x7F)?1:2;
    if(count>30){out+='\n';count=2;}
    out+=ch;
  }
  return out;
}

function getComp(cat,key){return compatibility?.[cat]?.[key]||null;}

function calculate(){
  missingInfo=[];
  const sei=splitChars(document.getElementById('sei').value);
  const mei=splitChars(document.getElementById('mei').value);
  if(!sei.length||!mei.length){alert("姓と名を入力してください。");return;}
  const s1=sei.map(charVal).reduce((a,b)=>a+b,0),s2=mei.map(charVal).reduce((a,b)=>a+b,0);
  const jin=charVal(sei[sei.length-1])+charVal(mei[0]);
  let reiTen=0,reiChi=0,reiGai=0;
  if(sei.length===1&&mei.length===1){reiChi=1;reiGai=2;}
  else if(sei.length===1){reiTen=1;reiGai=1;}
  else if(mei.length===1){reiChi=1;reiGai=1;}
  const ten=s1+reiTen,chi=s2+reiChi,gai=(s1+s2)-jin+reiGai,sou=s1+s2;
  const tenG=toGogyo(ten),jinG=toGogyo(jin),chiG=toGogyo(chi),gaiG=toGogyo(gai),souG=toGogyo(sou);

  let out='';
  out+=formatSection('五格診断結果');
  out+=formatItem('総格',sou,kikkou(sou),getDiagnosis('sou',sou))+'\n';
  out+=formatItem('天格',ten,'－','単独での吉凶判断はできません。')+'\n';
  out+=formatItem('人格',jin,kikkou(jin),getDiagnosis('jin',jin))+'\n';
  out+=formatItem('地格',chi,kikkou(chi),getDiagnosis('chi',chi))+'\n';
  out+=formatItem('外格',gai,kikkou(gai),getDiagnosis('gai',gai))+'\n\n';

  out+=formatSection('主格相性診断');
  const s=getComp('success',tenG+jinG);
  const f=getComp('foundation',chiG+jinG);
  const r=getComp('relation',gaiG+jinG);
  const t=getComp('total',souG+jinG);
  if(s)out+=`成功・発展運（主格⇔天格）${s.symbol}\n${wrap30(s.text)}\n${wrap30(s.advice)}\n\n`;
  if(f)out+=`基礎運（主格⇔地格）${f.symbol}\n${wrap30(f.text)}\n${wrap30(f.advice)}\n\n`;
  if(r)out+=`対人・職業運（主格⇔外格）${r.symbol}\n${wrap30(r.text)}\n${wrap30(r.advice)}\n\n`;
  if(t)out+=`総合バランス（主格⇔総画）${t.symbol}\n${wrap30(t.text)}\n${wrap30(t.advice)}\n`;

  if(missingInfo.length)out+='\n【未登録】\n'+missingInfo.join(' / ');
  document.getElementById('result').textContent=out;
}

function clearForm(){
  document.getElementById('sei').value='';
  document.getElementById('mei').value='';
  document.getElementById('result').textContent='まだ診断されていません。';
}

document.addEventListener('DOMContentLoaded',loadData);
</script>
</body>
</html>
