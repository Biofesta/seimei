<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>熊﨑式姓名判断（霊数補正式）</title>
<style>
  :root{--bg:#fbfbfb;--card:#fff;--muted:#666}
  body{
    font-family:"Yu Gothic","Hiragino Kaku Gothic ProN",Meiryo,monospace;
    background:var(--bg);
    margin:0;padding:24px;
    color:#222;line-height:1.8;
  }
  .wrap{max-width:920px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
  h1{font-size:20px;margin:0}
  .card{
    background:var(--card);
    padding:18px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(20,20,20,0.04);
  }
  label{display:block;margin:8px 0 4px;font-weight:600}
  input[type="text"]{
    width:100%;
    padding:10px;
    font-size:16px;
    border:1px solid #ddd;
    border-radius:6px;
  }
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  /* ▼スマホ表示調整 */
  @media(max-width:640px){
    .grid{grid-template-columns:1fr}
    pre{
      white-space:pre-wrap;
      word-break:break-word;
      font-size:15px;
      line-height:1.9;
    }
  }
  button{
    background:#1f8ef1;
    color:#fff;
    border:0;
    padding:10px 14px;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
  }
  button:disabled{opacity:0.5;cursor:not-allowed}
  pre{
    white-space:pre-wrap;
    word-break:break-word;
    background:#fafafa;
    padding:12px;
    border-radius:8px;
    border:1px dashed #eee;
    font-family:monospace;
    line-height:1.8;
    overflow-wrap:break-word;
  }
  .meta{font-size:13px;color:var(--muted);margin-top:8px}
  .btns{display:flex;gap:10px;margin-top:12px}
  #measure{position:fixed;left:-9999px;top:-9999px;visibility:hidden;white-space:nowrap;font-family:monospace;font-size:16px;}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>熊﨑式姓名判断</h1>
  </header>

  <section class="card">
    <form id="form" onsubmit="event.preventDefault(); calculate();">
      <div class="grid">
        <div>
          <label for="sei">姓（苗字）</label>
          <input id="sei" type="text" placeholder="例：永" autocomplete="off" />
        </div>
        <div>
          <label for="mei">名（名前）</label>
          <input id="mei" type="text" placeholder="例：太郎" autocomplete="off" />
        </div>
      </div>
      <div class="btns">
        <button id="runBtn" type="submit">診断する</button>
        <button type="button" onclick="clearForm()">クリア</button>
      </div>
    </form>
  </section>

  <section style="margin-top:16px" class="card">
    <h2 style="font-size:16px;margin:0 0 8px">診断結果</h2>
    <pre id="result">まだ診断されていません。</pre>
  </section>

  <section style="margin-top:16px" class="card" hidden>
    <div>デバッグ情報</div>
    <pre id="debug">-</pre>
  </section>
</div>

<div id="measure"></div>

<script>
let strokes = null, diagnosis = null, missingInfo = [];

async function loadData(){
  try{
    const [r1, r2] = await Promise.all([
      fetch("strokes_kumazaki_full.json"),
      fetch("diagnosis_data.json")
    ]);
    if(!r1.ok) throw new Error("画数辞書読み込み失敗");
    if(!r2.ok) throw new Error("診断データ読み込み失敗");
    strokes = await r1.json();
    diagnosis = await r2.json();
    document.getElementById('debug').textContent = 'データ読み込みOK。';
  }catch(e){
    document.getElementById('debug').textContent = '読み込みエラー：' + e.message;
    document.getElementById('runBtn').disabled = true;
  }
}

function splitChars(str){ return Array.from(String(str).trim()); }
function charVal(ch){
  if(!strokes) return 0;
  if(ch in strokes) return strokes[ch]||0;
  missingInfo.push(ch + "：未登録");
  return 0;
}
function kikkou(num){
  const good = new Set([1,3,5,6,7,8,11,13,15,16,17,18,21,23,24,25,31,32,33,35,37,39,41,45,47,48,52]);
  if(good.has(num)) return '吉';
  if(num === 0) return '不明';
  return '凶';
}
function toGogyo(n){
  const map={1:'木',2:'木',3:'火',4:'火',5:'土',6:'土',7:'金',8:'金',9:'水',0:'水'};
  return map[n%10];
}
function gogyouMatch(a,b,c){
  const rel={'木火土':'◎','火土金':'◎','土金水':'◎','金水木':'◎','水木火':'◎',
             '木土金':'△','火金水':'△','土水木':'△','金木火':'△','水火土':'△'};
  const key=a+b+c; return rel[key]||'○';
}
function getDiagnosis(type, num){
  if(!diagnosis || !diagnosis[type]) return '診断データなし';
  return diagnosis[type][String(num)] || '該当する診断文がありません。';
}

function displayWidth(str){
  let w=0;
  for(const ch of str){ w+=(ch.charCodeAt(0)<=0x7F)?1:2; }
  return w;
}
function getCharPixelWidth(){
  const meas=document.getElementById('measure');
  meas.style.fontFamily=window.getComputedStyle(document.getElementById('result')).fontFamily;
  meas.style.fontSize=window.getComputedStyle(document.getElementById('result')).fontSize;
  meas.textContent='M'; const halfW=meas.getBoundingClientRect().width;
  meas.textContent='あ'; const fullW=meas.getBoundingClientRect().width;
  return (halfW+fullW/2)/2;
}
function getPreColumns(){
  const pre=document.getElementById('result');
  const preWidth=pre.clientWidth-24;
  const charPixel=getCharPixelWidth()||8;
  return Math.max(20,Math.floor(preWidth/charPixel));
}
function wrapTextForHeader(headerWidth, fullCols, text){
  const available=Math.max(10,fullCols-headerWidth);
  const lines=[]; let cur='',curW=0,idx=0;
  while(idx<text.length){
    const ch=text[idx++]; const w=(ch.charCodeAt(0)<=0x7F)?1:2;
    if(curW+w>available){ lines.push(cur); cur=ch; curW=w; }
    else{ cur+=ch; curW+=w; }
  }
  if(cur.length) lines.push(cur);
  const full=Math.floor(headerWidth/2); const half=headerWidth%2;
  const indent='　'.repeat(full)+' '.repeat(half);
  let out=lines[0];
  for(let i=1;i<lines.length;i++) out+='\n'+indent+lines[i];
  return out;
}

/* === PC/スマホ両対応の表示制御 === */
function formatLineStrict(title,num,fortune,text){
  const isMobile = window.innerWidth <= 640;
  if(isMobile){
    return `${title}：${num}（${fortune}）\n${text}`;
  } else {
    const gap='　　';
    const header=`${title}：${String(num).padStart(2,' ')}（${fortune}）${gap}`;
    const headerWidth=displayWidth(header);
    const cols=getPreColumns();
    const wrapped=wrapTextForHeader(headerWidth,cols,text);
    return header+wrapped;
  }
}

function calculate(){
  missingInfo=[];
  const sei=splitChars(document.getElementById('sei').value||'');
  const mei=splitChars(document.getElementById('mei').value||'');
  if(sei.length===0||mei.length===0){alert('姓と名を入力してください。');return;}

  const s1=sei.map(charVal).reduce((a,b)=>a+b,0);
  const s2=mei.map(charVal).reduce((a,b)=>a+b,0);
  const jin=charVal(sei[sei.length-1])+charVal(mei[0]);
  let reiTen=0, reiChi=0, reiGai=0;

  if(sei.length===1 && mei.length===1){ reiChi=1; reiGai=2; }
  else if(sei.length===1){ reiTen=1; reiGai=1; }
  else if(mei.length===1){ reiChi=1; reiGai=1; }

  const ten=s1+reiTen;
  const chi=s2+reiChi;
  const gai=(s1+s2)-jin+reiGai;
  const sou=s1+s2;

  const tenG=toGogyo(ten), jinG=toGogyo(jin), chiG=toGogyo(chi);
  const gAtt=gogyouMatch(tenG,jinG,chiG);

  const lines=[];
  lines.push('【五格診断結果】\n');
  lines.push(formatLineStrict('総格',sou,kikkou(sou),getDiagnosis('sou',sou))+'\n\n');
  lines.push(formatLineStrict('天格',ten,'－','単独での吉凶判断はできません。')+'\n\n');
  lines.push(formatLineStrict('人格',jin,kikkou(jin),getDiagnosis('jin',jin))+'\n\n');
  lines.push(formatLineStrict('地格',chi,kikkou(chi),getDiagnosis('chi',chi))+'\n\n');
  lines.push(formatLineStrict('外格',gai,kikkou(gai),getDiagnosis('gai',gai))+'\n\n');
  lines.push('【三才五行配列】\n');
  lines.push(`天格：${tenG}　人格：${jinG}　地格：${chiG}\n\n`);
  lines.push('【三才相性診断】\n');
  lines.push(`${tenG} → ${jinG} → ${chiG}\n`);
  const msg=(gAtt==='◎')?'非常に良好で安定した運勢です。':(gAtt==='△')?'やや不調和。人間関係や環境の変化に注意。':'概ね良好で調和が取れています。';
  lines.push(`相性：${gAtt}　${msg}`);
  if(missingInfo.length){lines.push('\n\n【未登録】\n'+missingInfo.join(' / '));}
  document.getElementById('result').textContent=lines.join('');
}
function clearForm(){
  document.getElementById('sei').value='';
  document.getElementById('mei').value='';
  document.getElementById('result').textContent='まだ診断されていません。';
}
document.addEventListener('DOMContentLoaded',loadData);
</script>
</body>
</html>
