<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>熊﨑式姓名判断（最終版）</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
body {
  font-family: "Yu Gothic","Hiragino Kaku Gothic ProN",Meiryo,monospace;
  margin: 0; padding: 0;
  background: #fff;
  color: #222; line-height: 1.8;
}
.wrap { max-width: 900px; margin: 0 auto; padding: 20px; }

h1 { font-size: 20px; margin: 0; }

.card { background: #fff; padding: 16px; border-radius: 8px; }

.section-title { font-size: 20px; font-weight: bold; margin: 12px 0 8px; }
.kaku-title { font-size: 18px; font-weight: bold; margin-top: 10px; }
.expr { color: #8B4513; font-size: 14px; font-family: monospace; margin: 2px 0; }
.compat-subtitle { display: block; font-weight: bold; font-size: 16px; margin-top: 6px; margin-bottom: 0; }
.compatibility-section p { margin: 2px 0 8px 0; }

/* 印刷・PDF共通設定 */
@page { size: A4; margin: 10mm; }
@media print {
  header, form, .print-controls, #debug { display: none !important; }
  body { zoom: 0.9; }
}
.print-controls { display: flex; justify-content: center; gap: 120px; margin-top: 24px; }
.print-btn { padding: 10px 18px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; }
.print-btn.print { background: #4caf50; color: #fff; }
.print-btn.pdf { background: #2196f3; color: #fff; }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>熊﨑式姓名判断</h1></header>

  <section class="card">
    <form id="form" onsubmit="event.preventDefault(); calculate();">
      <label for="sei">姓（苗字）</label>
      <input id="sei" type="text" placeholder="例：矢﨑" />
      <label for="mei">名（名前）</label>
      <input id="mei" type="text" placeholder="例：亨" />
      <div class="print-controls">
        <button type="submit" id="runBtn" class="print-btn print">診断</button>
        <button type="button" class="print-btn pdf" id="pdfBtn">PDF保存</button>
      </div>
    </form>
  </section>

  <section class="card">
    <div id="result">まだ診断されていません。</div>
  </section>

  <section class="card">
    <div>デバッグ情報</div>
    <pre id="debug">-</pre>
  </section>
</div>

<script>
let strokes=null,diagnosis=null,compatibility=null;

async function loadData(){
  const [r1,r2,r3]=await Promise.all([
    fetch("strokes_kumazaki_full.json"),
    fetch("diagnosis_data.json"),
    fetch("diagnosis_compatibility.json")
  ]);
  strokes=await r1.json(); diagnosis=await r2.json(); compatibility=await r3.json();
}

function splitChars(s){return Array.from(String(s).trim());}
function charVal(c){return strokes[c]||0;}
function kikkou(n){const good=new Set([1,3,5,6,7,8,11,13,15,16,17,18,21,23,24,25,31,32,33,35,37,38,39,41,45,47,48,52]);return good.has(n)?'吉':'凶';}
function toGogyo(n){const m={1:'木',2:'木',3:'火',4:'火',5:'土',6:'土',7:'金',8:'金',9:'水',0:'水'};return m[n%10];}
function getDiagnosis(type,num){return diagnosis[type][String(num)]||'';}
function wrapZenkaku(t){return t.replace(/\n+/g,'');}

function pickCompat(cat,main,other){
  const k=main+other;
  const o=compatibility[cat][k]||{symbol:'',text:''};
  return o;
}

function calcExpr(chars){const parts=chars.map(c=>`${c}(${charVal(c)})`);return `<div class="expr">[ ${parts.join('+')} ]</div>`;}

function calculate(){
  const sei=splitChars(document.getElementById('sei').value);
  const mei=splitChars(document.getElementById('mei').value);
  if(!sei.length||!mei.length){alert('姓と名を入力してください');return;}
  const s1=sei.map(charVal).reduce((a,b)=>a+b,0);
  const s2=mei.map(charVal).reduce((a,b)=>a+b,0);
  const jin=charVal(sei[sei.length-1])+charVal(mei[0]);
  const ten=s1,chi=s2,gai=(s1+s2)-jin,sou=s1+s2;

  const tenG=toGogyo(ten),jinG=toGogyo(jin),chiG=toGogyo(chi),gaiG=toGogyo(gai),souG=toGogyo(sou);
  const sSucc=pickCompat('success',jinG,tenG);
  const sFoun=pickCompat('foundation',jinG,chiG);
  const sRela=pickCompat('relation',jinG,gaiG);
  const sOver=pickCompat('overall',jinG,souG);

  const lines=[];
  lines.push('<div id="main-diagnosis">');
  lines.push('<div class="section-title">【五格診断結果】</div>');
  lines.push(`<div class="kaku-title">総格：${sou}（${kikkou(sou)}）</div>${calcExpr([...sei,...mei])}${wrapZenkaku(getDiagnosis('sou',sou))}`);
  lines.push(`<div class="kaku-title">天格：${ten}（${kikkou(ten)}）</div>${calcExpr(sei)}${wrapZenkaku(getDiagnosis('ten',ten))}`);
  lines.push(`<div class="kaku-title">主格：${jin}（${kikkou(jin)}）</div>${calcExpr([sei[sei.length-1],mei[0]])}${wrapZenkaku(getDiagnosis('jin',jin))}`);
  lines.push(`<div class="kaku-title">地格：${chi}（${kikkou(chi)}）</div>${calcExpr(mei)}${wrapZenkaku(getDiagnosis('chi',chi))}`);
  lines.push(`<div class="kaku-title">外格：${gai}（${kikkou(gai)}）</div>${calcExpr([...sei.slice(0,-1),...mei.slice(1)])}${wrapZenkaku(getDiagnosis('gai',gai))}`);
  lines.push('<div class="section-title">【主格相性診断】</div>');
  lines.push(`<span class="compat-subtitle">成功・発展運（主格⇔天格）診断⇒${sSucc.symbol}</span><p>${wrapZenkaku(sSucc.text)}</p>`);
  lines.push(`<span class="compat-subtitle">基礎運（主格⇔地格）診断⇒${sFoun.symbol}</span><p>${wrapZenkaku(sFoun.text)}</p>`);
  lines.push(`<span class="compat-subtitle">対人・職業運（主格⇔外格）診断⇒${sRela.symbol}</span><p>${wrapZenkaku(sRela.text)}</p>`);
  lines.push(`<span class="compat-subtitle">総合バランス（主格⇔総画）診断⇒${sOver.symbol}</span><p>${wrapZenkaku(sOver.text)}</p>`);
  lines.push('</div>');

  document.getElementById('result').innerHTML = lines.join('');
}

document.getElementById('pdfBtn').addEventListener('click',()=>{
  const main=document.querySelector('#main-diagnosis');
  const opt={margin:5,filename:'姓名判断結果.pdf',image:{type:'jpeg',quality:1},
    html2canvas:{scale:2,scrollY:0,windowWidth:900},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
  html2pdf().set(opt).from(main).toPdf().get('pdf').then(pdf=>{
    if(pdf.internal.getNumberOfPages()>1)pdf.deletePage(2);
  }).save();
});

document.addEventListener('DOMContentLoaded',loadData);
</script>
</body>
</html>
