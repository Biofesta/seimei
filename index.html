<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>熊﨑式姓名判断（五格診断と主格相性診断）簡易版 by Biofesta</title>
<style>
  :root{--bg:#fbfbfb;--card:#fff;--muted:#666}
  body{
    font-family:"Yu Gothic","Hiragino Kaku Gothic ProN",Meiryo,monospace;
    background:var(--bg);
    margin:0;padding:24px;
    color:#222;line-height:1.8;
  }
  .wrap{max-width:920px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
  h1{font-size:20px;margin:0}
  .card{
    background:var(--card);
    padding:18px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(20,20,20,0.04);
  }
  label{display:block;margin:8px 0 4px;font-weight:600}
  input[type="text"]{
    width:100%;
    padding:10px;
    font-size:16px;
    border:1px solid #ddd;
    border-radius:6px;
  }
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:640px){
    .grid{grid-template-columns:1fr}
    pre{white-space:pre-wrap;word-break:break-word;font-size:15px;line-height:1.9;}
  }
  button{
    background:#1f8ef1;color:#fff;border:0;
    padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700;
  }
  button:disabled{opacity:0.5;cursor:not-allowed}
  pre{
    white-space:pre-wrap;word-break:break-word;background:#fafafa;
    padding:12px;border-radius:8px;border:1px dashed #eee;font-family:monospace;
    line-height:1.8;overflow-wrap:break-word;font-size:16px;
  }
  .btns{display:flex;gap:10px;margin-top:12px}
  .brown{color:#8B4513;}
  .section-title{font-size:20px;font-weight:bold;margin:20px 0 8px;}
  .kaku-title{font-size:18px;font-weight:bold;}
  .compat-subtitle{font-size:16px;font-weight:bold;}

  /* 印刷設定：左20mm + 上10mm詰め相当 */
  @page {
    size: A4;
    margin-top: -2mm;
    margin-right: 8mm;
    margin-bottom: 8mm;
    margin-left: 20mm;
  }
  @media print {
    header, form, .print-area button {display:none !important;}
    body {background:#fff !important;color:#000 !important;margin:0;padding:0;}
    .wrap {zoom:0.86;overflow:hidden;page-break-inside: avoid;margin-top:-10mm;}
    pre {background:#fff !important;border:none !important;}
    #print-header {display:block !important;}
  }

  /* 印刷／PDFヘッダー（ロゴ＋タイトル） */
  #print-header {
    display:none;text-align:center;margin-bottom:14px;
  }
  #print-header img {
    width:30mm;height:10mm;object-fit:contain;display:block;margin:0 auto 4mm;
  }
  #print-header span {
    display:block;font-size:16px;font-weight:bold;
  }

  .print-buttons {margin-top:48px;display:flex;gap:10px;}
  .print-btn {background:#4caf50;color:#fff;padding:10px 18px;border:none;border-radius:8px;font-weight:700;cursor:pointer;}
  .pdf-btn {background:#1f8ef1;color:#fff;padding:10px 18px;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:background .2s;}
  .pdf-btn:hover {background:#409eff;}
</style>

<!-- 外部ライブラリ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<div class="wrap">
  <header><h1>熊﨑式姓名判断（五格診断と主格相性診断）簡易版</h1></header>

  <section class="card">
    <form id="form" onsubmit="event.preventDefault(); calculate();">
      <div class="grid">
        <div>
          <label for="sei">姓（苗字）</label>
          <input id="sei" type="text" placeholder="例：矢﨑" autocomplete="off" />
        </div>
        <div>
          <label for="mei">名（名前）</label>
          <input id="mei" type="text" placeholder="例：亨" autocomplete="off" />
        </div>
      </div>
      <div class="btns">
        <button id="runBtn" type="submit">診断する</button>
        <button type="button" onclick="clearForm()">クリア</button>
      </div>
    </form>
  </section>

  <section style="margin-top:16px" class="card print-area">
    <!-- 印刷・PDFヘッダー -->
    <div id="print-header">
      <img src="logo_biofesta.jpg" alt="Biofestaロゴ">
      <span>姓名判断（五格診断と主格相性診断）簡易版　by Biofesta</span>
    </div>

    <h2 style="font-size:16px;margin:0 0 8px">診断結果</h2>
    <pre id="result">まだ診断されていません。</pre>

    <div class="print-buttons">
      <button class="print-btn" id="printBtn">印刷</button>
      <button class="pdf-btn" id="pdfBtn">PDF保存</button>
    </div>
  </section>

  <section style="margin-top:16px" class="card" hidden>
    <div>デバッグ情報</div>
    <pre id="debug">-</pre>
  </section>
</div>

<script>
/* ---------------- 変数 ---------------- */
let strokes=null, diagnosis=null, compatibility=null, missingInfo=[];

/* ---------------- データ読込 ---------------- */
async function loadData(){
  try{
    const [r1,r2,r3]=await Promise.all([
      fetch("strokes_kumazaki_full.json"),
      fetch("diagnosis_data.json"),
      fetch("diagnosis_compatibility.json")
    ]);
    if(!r1.ok||!r2.ok||!r3.ok) throw new Error("ファイル読込失敗");
    strokes=await r1.json();
    diagnosis=await r2.json();
    compatibility=await r3.json();
    document.getElementById('debug').textContent='データ読み込みOK。';
  }catch(e){
    document.getElementById('debug').textContent='読み込みエラー：'+e.message;
    document.getElementById('runBtn').disabled=true;
  }
}

/* ---------------- 共通関数 ---------------- */
function splitChars(str){ return Array.from(String(str).trim()); }
function charVal(ch){
  if(!strokes) return 0;
  if(ch in strokes) return strokes[ch]||0;
  missingInfo.push(ch+"：未登録");
  return 0;
}
function kikkou(num){
  const n=Number(num);
  const good=new Set([1,3,5,6,7,8,11,13,15,16,17,18,21,23,24,25,31,32,33,35,37,38,39,41,45,47,48,52]);
  if(good.has(n)) return '吉';
  if(n===0) return '不明';
  return '凶';
}
function toGogyo(n){
  const map={1:'木',2:'木',3:'火',4:'火',5:'土',6:'土',7:'金',8:'金',9:'水',0:'水'};
  return map[n%10];
}
function getDiagnosis(type,num){
  if(!diagnosis||!diagnosis[type]) return '診断データなし';
  return diagnosis[type][String(num)]||'該当する診断文がありません。';
}
function wrapZenkaku(text,cols=32){
  let out=[],cur='',w=0;
  for(const ch of text){
    const add=(ch.charCodeAt(0)<=0x7F)?1:2;
    if(w+add>cols*2){ out.push(cur); cur=ch; w=add; }
    else{ cur+=ch; w+=add; }
  }
  if(cur) out.push(cur);
  return out.join('\n');
}
function pickCompat(cat,mainEl,otherEl){
  if(!compatibility||!compatibility[cat]) return {symbol:'',text:'（相性データ未読込）'};
  const key=mainEl+otherEl;
  const obj=compatibility[cat][key];
  if(!obj) return {symbol:'',text:'（該当組合せなし）'};
  let text=obj.text||'';
  text=text.replace(/<span[^>]*>注：<\/span>/gi,'【要注意】');
  return {symbol:obj.symbol||'',text:text};
}
function calcExpr(chars, addRei=false){
  const parts=chars.map(c=>`${c}(${charVal(c)})`);
  if(addRei) parts.push('霊数1');
  return `<span class="brown">[ ${parts.join('＋')} ]</span>`;
}

/* ---------------- 診断本体 ---------------- */
function calculate(){
  missingInfo=[];
  const sei=splitChars(document.getElementById('sei').value||'');
  const mei=splitChars(document.getElementById('mei').value||'');
  if(sei.length===0||mei.length===0){ alert('姓と名を入力してください。'); return; }

  const s1=sei.map(charVal).reduce((a,b)=>a+b,0);
  const s2=mei.map(charVal).reduce((a,b)=>a+b,0);
  const jin=charVal(sei[sei.length-1])+charVal(mei[0]);

  let reiTen=0,reiChi=0,reiGai=0;
  if(sei.length===1&&mei.length===1){reiChi=1;reiGai=2;}
  else if(sei.length===1){reiTen=1;reiGai=1;}
  else if(mei.length===1){reiChi=1;reiGai=1;}

  const ten=s1+reiTen,chi=s2+reiChi,sou=s1+s2;

  let gaiExprChars=[],gai=0;
  if(mei.length===1){gai=charVal(sei[0])+1;gaiExprChars=[sei[0]];}
  else{gai=(s1+s2)-jin+reiGai;gaiExprChars=[sei[0], mei[mei.length-1]];}

  const tenG=toGogyo(ten),jinG=toGogyo(jin),chiG=toGogyo(chi),gaiG=toGogyo(gai),souG=toGogyo(sou);

  const sSucc=pickCompat('success',jinG,tenG);
  const sFoun=pickCompat('foundation',jinG,chiG);
  const sRela=pickCompat('relation',jinG,gaiG);
  const sOver=pickCompat('overall',jinG,souG);

  const lines=[];
  lines.push('<span class="section-title">【五格診断結果】</span>\n');
  lines.push(`<span class="kaku-title">総格：${sou}（${kikkou(sou)}）</span>　${calcExpr([...sei,...mei])}\n${wrapZenkaku(getDiagnosis('sou',sou))}\n`);
  lines.push(`\n<span class="kaku-title">天格：${ten}（－）</span>　${calcExpr(sei, reiTen===1)}\n${wrapZenkaku('単独での吉凶判断はありません。')}${reiTen===1?'\n<span class="brown">※ 姓または名が一文字のため霊数を加算しています。</span>':''}\n`);
  lines.push(`\n<span class="kaku-title">主格：${jin}（${kikkou(jin)}）</span>　${calcExpr([sei[sei.length-1], mei[0]])}\n${wrapZenkaku(getDiagnosis('jin',jin))}\n`);
  lines.push(`\n<span class="kaku-title">地格：${chi}（${kikkou(chi)}）</span>　${calcExpr(mei, reiChi===1)}\n${wrapZenkaku(getDiagnosis('chi',chi))}${reiChi===1?'\n<span class="brown">※ 姓または名が一文字のため霊数を加算しています。</span>':''}\n`);
  lines.push(`\n<span class="kaku-title">外格：${gai}（${kikkou(gai)}）</span>　${calcExpr(gaiExprChars, mei.length===1)}\n${wrapZenkaku(getDiagnosis('gai',gai))}${mei.length===1?'\n<span class="brown">※ 名が一文字のため霊数を加算しています。</span>':''}\n`);

  lines.push('\n\n<span class="section-title" style="color:#000;">【主格相性診断】</span>\n');
  lines.push(`<span class="compat-subtitle">成功・発展運（主格⇔天格）</span> ${sSucc.symbol}\n${wrapZenkaku(sSucc.text)}\n`);
  lines.push(`\n<span class="compat-subtitle">基礎運（主格⇔地格）</span> ${sFoun.symbol}\n${wrapZenkaku(sFoun.text)}\n`);
  lines.push(`\n<span class="compat-subtitle">対人・職業運（主格⇔外格）</span> ${sRela.symbol}\n${wrapZenkaku(sRela.text)}\n`);
  lines.push(`\n<span class="compat-subtitle">総合バランス（主格⇔総画）</span> ${sOver.symbol}\n${wrapZenkaku(sOver.text)}\n`);

  if(missingInfo.length){lines.push('\n\n【未登録】\n'+missingInfo.join(' / '));}

  document.getElementById('result').innerHTML=lines.join('');
}

/* クリア */
function clearForm(){
  document.getElementById('sei').value='';
  document.getElementById('mei').value='';
  document.getElementById('result').textContent='まだ診断されていません。';
}

/* 初期化 */
document.addEventListener('DOMContentLoaded',()=>{
  loadData();

  function setPrintTitle(){
    const sei=document.getElementById("sei").value.trim();
    const mei=document.getElementById("mei").value.trim();
    const now=new Date();
    const dateStr=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
    document.title=`姓名判断_${sei}${mei}_${dateStr}`;
  }

  document.getElementById("printBtn").addEventListener("click",()=>{
    setPrintTitle();
    window.print();
  });

  document.getElementById("pdfBtn").addEventListener("click",async()=>{
    setPrintTitle();
    const { jsPDF } = window.jspdf;
    const element = document.querySelector(".print-area");
    const buttons = element.querySelector(".print-buttons");
    const header = document.getElementById("print-header");
    const logo = header.querySelector("img");

    // 一時的にUI調整
    buttons.style.display = "none";
    header.style.display = "block";

    // ロゴ読み込み待機
    if (logo && !logo.complete) {
      await new Promise(resolve => { logo.onload = resolve; });
    }

    // 画像化
    const canvas = await html2canvas(element,{scale:2,backgroundColor:"#fff"});
    const imgData = canvas.toDataURL("image/jpeg", 1.0);

    // A4 PDF化（縦比率補正 + 上詰め）
    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = 210;
    const imgWidth = pageWidth;
    let imgHeight = canvas.height * imgWidth / canvas.width;
    imgHeight *= 0.83; // ← 縦方向20%縮小補正
    const yOffset = -5; // ← 上方向に5mm詰める
    pdf.addImage(imgData, "JPEG", 0, yOffset, imgWidth, imgHeight);

    // 保存名
    const sei=document.getElementById("sei").value.trim();
    const mei=document.getElementById("mei").value.trim();
    const now=new Date();
    const dateStr=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
    pdf.save(`姓名判断_${sei}${mei}_${dateStr}.pdf`);

    // 後片付け
    buttons.style.display = "flex";
    header.style.display = "none";
  });
});
</script>
</body>
</html>
